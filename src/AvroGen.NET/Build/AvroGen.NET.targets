<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildThisFileDirectory)AvroGen.NET.props" />
  
  <ItemGroup>
    <AvailableItemName Include="AvroSchema" />
  </ItemGroup>

  <UsingTask TaskName="AvroGen.NET.GenerateAvroClassesTask" 
             AssemblyFile="$(MSBuildThisFileDirectory)AvroGen.NET.dll"/>

  <Target Name="GenerateAvroClassesFromSchemaRegistry" BeforeTargets="CoreCompile">
    <Message Text="Starting Avro class generation..." Importance="high" />
    <Message Text="MSBuildProjectDirectory: $(MSBuildProjectDirectory)" Importance="high" />
    <Message Text="GeneratedCodePath: $(GeneratedCodePath)" Importance="high" />
    
    <ItemGroup>
      <AvroSchemaToGenerate Include="@(AvroSchema)">
        <OutputPath>%(OutputPath)</OutputPath>
        <SchemaRegistryUrl>%(SchemaRegistryUrl)</SchemaRegistryUrl>
        <Subject>%(Subject)</Subject>
        <Version>%(Version)</Version>
      </AvroSchemaToGenerate>
    </ItemGroup>

    <Message Text="Found schemas: @(AvroSchemaToGenerate)" Importance="high" />
    <Message Text="Schema details:" Importance="high" />
    <Message Text="  %(AvroSchemaToGenerate.Identity)" Importance="high" />
    <Message Text="  URL: %(AvroSchemaToGenerate.SchemaRegistryUrl)" Importance="high" />
    <Message Text="  Subject: %(AvroSchemaToGenerate.Subject)" Importance="high" />
    <Message Text="  Version: %(AvroSchemaToGenerate.Version)" Importance="high" />
    <Message Text="  Output: %(AvroSchemaToGenerate.OutputPath)" Importance="high" />

    <AvroGen.NET.GenerateAvroClassesTask
      Schemas="@(AvroSchemaToGenerate)"
      OutputDirectory="$(GeneratedCodePath)"
      SchemaRegistryUrl="%(AvroSchemaToGenerate.SchemaRegistryUrl)"/>

    <ItemGroup>
      <None Include="$(GeneratedCodePath)/**/*.cs">
        <Link>Generated\%(RecursiveDir)%(Filename)%(Extension)</Link>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </None>
    </ItemGroup>
  </Target>

  <!-- Clean up generated files -->
  <Target Name="CleanGeneratedAvroCode" BeforeTargets="Clean">
    <Delete Files="@(None)" Condition="'%(None.Link)' != '' and $([System.String]::Copy('%(None.Link)').StartsWith('Generated\'))" />
  </Target>
</Project>
